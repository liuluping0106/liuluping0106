<rss version="2.0">
<channel>

<item>
  <title>远程下载视频成m3u8形式</title>
  <link>https://www.liulp.club/2020/08/%E8%BF%9C%E7%A8%8B%E4%B8%8B%E8%BD%BD%E8%A7%86%E9%A2%91%E6%88%90m3u8%E5%BD%A2%E5%BC%8F/</link>
    <description>&lt;p&gt;成功使用远程下载自动切片m3u8，且实现在线播放。&lt;/p&gt;
&lt;h2 id=&#34;技术博客&#34;&gt;技术博客&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.jianshu.com/p/273bdb4c240b&#34;&gt;mp4切片m3u8&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://ffmpeg.org/&#34;&gt;ffmpeg&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.moerats.com/archives/482/&#34;&gt;aria2远程下载&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.moerats.com/archives/1006/&#34;&gt;远程上传到onedrive&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://blog.csdn.net/boyit0/article/details/88579330&#34;&gt;video.js实现m3u8播放&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;实现过程&#34;&gt;实现过程&lt;/h2&gt;
&lt;p&gt;远端执行代码：&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash

GID=&amp;quot;$1&amp;quot;;
FileNum=&amp;quot;$2&amp;quot;;
File=&amp;quot;$3&amp;quot;;
MinSize=&amp;quot;5&amp;quot;  #限制最低上传大小，默认5k
MaxSize=&amp;quot;15728640&amp;quot;;
Thread=&amp;quot;5&amp;quot;;  #默认3线程，自行修改，服务器配置不好的话，不建议太多
Block=&amp;quot;15&amp;quot;;  #默认分块20m，自行修改
RemoteDIR=&amp;quot;cloud&amp;quot;;  #上传到Onedrive的路径，默认为根目录，如果要上传到MOERATS目录，&amp;quot;&amp;quot;里面请填成MOERATS
LocalDIR=&amp;quot;/usr/local/caddy/www/aria2/Download&amp;quot;;  #Aria2下载目录，记得最后面加上/
Uploader=&amp;quot;/usr/local/bin/OneDriveUploader&amp;quot;;  #上传的程序完整路径，默认为本文安装的目录
Config=&amp;quot;/root/auth.json&amp;quot;;  #初始化生成的配置auth.json绝对路径，参考第3步骤生成的路径


# 调用ffmpeg
cd /usr/local/caddy/www/aria2/Download
for files in `ls`
do
    # 截取文件名的前两个字符
    object=${files};
    fname=${files%.*};
    # 截取文件的后四个字符
    bname=${files:0-3};
    # 拼接成文件名
    if [ $bname = mp4 ];then
        mkdir $fname;
        ffmpeg -i $object -c copy -bsf:v h264_mp4toannexb cs.ts
        ffmpeg -i cs.ts -c copy -map 0 -f segment -segment_list ‘$fname/cs.m3u8’ -segment_time 20 ‘$fname/cs-%03d.ts’
        rm cs.ts
    fi
done

if [[ -z $(echo &amp;quot;$FileNum&amp;quot; |grep -o &#39;[0-9]*&#39; |head -n1) ]]; then FileNum=&#39;0&#39;; fi
if [[ &amp;quot;$FileNum&amp;quot; -le &#39;0&#39; ]]; then exit 0; fi
if [[ &amp;quot;$#&amp;quot; != &#39;3&#39; ]]; then exit 0; fi

function LoadFile(){
  if [[ ! -e &amp;quot;${Uploader}&amp;quot; ]]; then return; fi
  IFS_BAK=$IFS
  IFS=$&#39;\n&#39;
  tmpFile=&amp;quot;$(echo &amp;quot;${File/#$LocalDIR}&amp;quot; |cut -f1 -d&#39;/&#39;)&amp;quot;
  FileLoad=&amp;quot;${LocalDIR}${tmpFile}&amp;quot;
  if [[ ! -e &amp;quot;${FileLoad}&amp;quot; ]]; then return; fi
  ItemSize=$(du -s &amp;quot;${FileLoad}&amp;quot; |cut -f1 |grep -o &#39;[0-9]*&#39; |head -n1)
  if [[ -z &amp;quot;$ItemSize&amp;quot; ]]; then return; fi
  if [[ &amp;quot;$ItemSize&amp;quot; -ge &amp;quot;$MaxSize&amp;quot; ]]; then
    echo -ne &amp;quot;\033[33m${FileLoad} \033[0mtoo large to spik.\n&amp;quot;;
    return;
  fi
  ${Uploader} -c &amp;quot;${Config}&amp;quot; -t &amp;quot;${Thread}&amp;quot; -b &amp;quot;${Block}&amp;quot; -s &amp;quot;${FileLoad}&amp;quot; -r &amp;quot;${RemoteDIR}&amp;quot; -skip
  if [[ $? == &#39;0&#39; ]]; then
    rm -rf &amp;quot;${FileLoad}&amp;quot;;
  fi
  IFS=$IFS_BAK
}
LoadFile;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;效果&#34;&gt;效果&lt;/h2&gt;
&lt;iframe id=&#34;m3u8iframe&#34;  src=&#34;https://www.liulp.club/m3u8/index.html?url=https://drive.liulp.club/Download/%e8%b4%9f%e5%bf%83%e4%ba%baBD%e4%b8%ad%e5%ad%97/cs.m3u8&#34;
    width=&#34;100%&#34; height=&#34;600&#34; allowfullscreen=&#34;true&#34; frameborder=&#34;0&#34; scrolling=&#39;no&#39;&gt;
&lt;/iframe&gt;</description>
  <pubDate>Tue, 18 Aug 2020 19:17:28 +0800</pubDate>
  
  <guid>https://www.liulp.club/2020/08/%E8%BF%9C%E7%A8%8B%E4%B8%8B%E8%BD%BD%E8%A7%86%E9%A2%91%E6%88%90m3u8%E5%BD%A2%E5%BC%8F/</guid>
</item>

</channel>
</rss>